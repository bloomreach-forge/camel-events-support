<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia at 2017-03-27
 | Rendered using Hippo Forge Maven Skin 1.04.00 based on Apache Maven Fluido Skin
-->
<!--[if lt IE 7]><html id="ie6" xmlns="http://www.w3.org/1999/xhtml"  xml:lang="en" lang="en"><![endif]-->
<!--[if IE 7]><html id="ie7" xmlns="http://www.w3.org/1999/xhtml"  xml:lang="en" lang="en"><![endif]-->
<!--[if IE 8]><html id="ie8" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en"><![endif]-->
<!--[if IE 9]><html id="ie9" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en"><![endif]-->
<!--[if !IE]>--><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en"><!--<![endif]-->

<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
                    <meta name="Date-Revision-yyyymmdd" content="20170327"/>
                <meta http-equiv="Content-Language" content="en"/>
        <title>Apache Camel - Hippo Events Support Documentation &#x2013; Demo 2: ElasticSearch Search Engine Integration</title>
    <link rel="stylesheet" href="./css/forge-maven-skin-syntaxhighlighter-1.04.00.min.css"/>
    <link rel="stylesheet" href="./css/forge-maven-skin-1.04.00.min.css"/>
    <link rel="stylesheet" href="./css/site.css"/>
    <link rel="stylesheet" href="./css/print.css" media="print"/>

        
    <script type="text/javascript" src="./js/forge-maven-skin-syntaxhighlighter-1.04.00.min.js"></script>
    <script type="text/javascript" src="./js/forge-maven-skin-1.04.00.min.js"></script>

    
            </head>
    <body>

        
    
    
    <div class="container-fluid">
        <div class="row-fluid">
            <div id="header">
                <div id="logo">
                    <a href="http://www.onehippo.com">
                        <img src="./images/hipposkin/hippo-logo.png" alt="Hippo Logo" />
                    </a>
                </div>

                <h1>
                                            Apache Camel - Hippo Events Support Documentation
                    
                </h1>
                <div class="clearfix"></div>
            </div>
        </div>

        <div class="row-fluid">
            <div id="breadcrumbs" class="clearfix">
                <ul class="breadcrumb">
                                
                                        
                            <li id="publishDate">Last Published: 2017-03-27</li>
                                                                                                                                                </ul>

                <div class="links">
                    <a href="https://www.onehippo.com">Onehippo.com</a>
                    <a href="https://www.onehippo.org">Onehippo.org</a>
                </div>
            </div>
        </div>



            
    <div class="row-fluid">
        <div id="leftColumn" class="span3">
            <div class="well sidebar-nav">
                <ul class="nav nav-list">
                                        <li class="nav-header">Home</li>
                                                           
        <li>
    
                                                <a href="index.html" title="Home">
                    <i class="none"></i>
                Home</a>
                    </li>
                               
        <li>
    
                                                <a href="release-notes.html" title="Release Notes">
                    <i class="none"></i>
                Release Notes</a>
                    </li>
                                                            <li class="nav-header">Usage</li>
                                                           
        <li>
    
                                                <a href="component-hippoevent.html" title="Hippo Event Component">
                    <i class="none"></i>
                Hippo Event Component</a>
                    </li>
                               
        <li>
    
                                                <a href="component-reposchedjob.html" title="Hippo Repository Scheduler Job Component">
                    <i class="none"></i>
                Hippo Repository Scheduler Job Component</a>
                    </li>
                               
        <li>
    
                                                <a href="util-camelcontextutils.html" title="Utils: CamelContextUtils">
                    <i class="none"></i>
                Utils: CamelContextUtils</a>
                    </li>
                                                            <li class="nav-header">Demo</li>
                                                           
        <li>
    
                                                <a href="aboutdemo.html" title="About Demo Project">
                    <i class="none"></i>
                About Demo Project</a>
                    </li>
                               
        <li>
    
                                                <a href="demo-solr-integration.html" title="Demo 1: Solr Search Engine Integration">
                    <i class="none"></i>
                Demo 1: Solr Search Engine Integration</a>
                    </li>
                               
        <li class="active">
    
                        <a href="#"><i class="none"></i>Demo 2: ElasticSearch Engine Integration</a>
                </li>
                               
        <li>
    
                                                <a href="demo-integration-activemq.html" title="Demo 3: Running with ActiveMQ">
                    <i class="none"></i>
                Demo 3: Running with ActiveMQ</a>
                    </li>
                                                            <li class="nav-header">Presentations and Blogs</li>
                                                           
        <li>
    
                                                <a href="http://www.onehippo.org/labs/integrating-hippo-cms-with-elastic-search-engine.html" class="externalLink" title="Integrating Hippo CMS with elasticsearch Engine">
                    <i class="none"></i>
                Integrating Hippo CMS with elasticsearch Engine</a>
                    </li>
                                                            <li class="nav-header">Project Documentation</li>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
        <li>
    
                                                <a href="project-info.html" title="Project Information">
                    <i class="icon-chevron-right"></i>
                Project Information</a>
                                </li>
                                                                                                                                                                                                                                                                                                                                                                                                                           
        <li>
    
                                                <a href="project-reports.html" title="Project Reports">
                    <i class="icon-chevron-right"></i>
                Project Reports</a>
                                </li>
                        </ul>

                
                <hr class="divider"/>

                <div id="poweredBy">
                                            <div class="clear"></div>
                                            <div class="clear"></div>
                                            <div class="clear"></div>
                                                <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
            <img class="builtBy" alt="Built by Maven" src="./images/logos/maven-feather.png"/>
        </a>
                            </div>
            </div>
        </div>
    
        
        <div id="bodyColumn"  class="span9" >
                                
            <!-- Copyright 2011 Hippo Licensed under the Apache License, Version 2.0
    (the "License"); you may not use this file except in compliance with
    the License. You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0 Unless required by
    applicable law or agreed to in writing, software distributed under
    the License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES
    OR CONDITIONS OF ANY KIND, either express or implied. See the
    License for the specific language governing permissions and
    limitations under the License. -->
  

    <div class="section">
<h2><a name="Demo_2:_ElasticSearch_Search_Engine_Integration"></a>Demo 2: ElasticSearch Search Engine Integration</h2>

      
<div class="section">
<h3><a name="Overview"></a>Overview</h3>
        
<p>
        </p>

        
<table border="0" class="table table-striped">
          
<tr class="a">
            
<th>Route name</th>
            
<th>Description</th>
          </tr>
          
<tr class="b">
            
<td>
              Route-HippoEventBus-to-File
            </td>
            
<td>
              Receives an HippoEventBus event and store it into a file under the inbox folder.
            </td>
          </tr>
        </table>
        
<p>
          <img src="images/hippoevt-to-file.png" alt="Hippo Event to File" />
        </p>
        
<table border="0" class="table table-striped">
          
<tr class="a">
            
<th>Route name</th>
            
<th>Description</th>
          </tr>
          
<tr class="b">
            
<td>
              Route-File-to-Rest
            </td>
            
<td>
              Polls the inbox folder to read a JSON message file and invokes the specified REST service URL.
            </td>
          </tr>
        </table>
        
<p>
          <img src="images/file-to-rest.png" alt="Hippo Event to File" />
        </p>
      </div>

      
<div class="section">
<h3><a name="Install_and_Run_ElasticSearch_locally"></a>Install and Run ElasticSearch locally</h3>

        
<p>
          To test this scenario, it is required to run <a class="externalLink" href="http://www.elasticsearch.org/" target="_blank">ElasticSearch</a> locally.
        </p>
        
<p>
          The demo project expects the ElasticSearch running at port 9200 and 9300 by default.
        </p>
        
<p>
          To install ElasticSearch, you can follow the following simplified steps for testing purpose only.
        </p>
        
<ol style="list-style-type: decimal">
          
<li>
            Download the latest version of ElasticSearch at 
            <a class="externalLink" href="http://www.elasticsearch.org/download/" target="_blank">http://www.elasticsearch.org/download/</a>.
          </li>
          
<li>
            Extract the archive file into the project root folder.
            So, for example, you will have 'elasticsearch-x.x.x' subfolder in the project root folder.
          </li>
          
<li>
            (Optional) For your convenience, you can install an ElasticSearch frontend plugin like the following example:
            
<ul>
              
<li>
                Move to the ElasticSearch home directory:
                <br />
                <br />
                <tt>$ cd ./elasticsearch-*/</tt>
                <br />
                <br />
              </li>
              
<li>
                Run the following to install <a class="externalLink" href="https://github.com/mobz/elasticsearch-head"><b>elasticsearch-head</b></a>,
                a web front end for an Elasticsearch cluster.
                <br />
                <br />
                <tt>$ sudo bin/plugin install mobz/elasticsearch-head</tt>
                <br />
                <br />
              </li>
            </ul>
          </li>
          
<li>
            Start ElasticSearch (You can type Ctrl+C to stop it):
            <br />
            <br />
            <tt>$ cd ./elasticsearch-*/bin</tt>
            <br />
            <tt>$ ./elasticsearch</tt>
            <br />
            <br />
          </li>
          
<li>
            If you installed <a class="externalLink" href="https://github.com/mobz/elasticsearch-head"><b>elasticsearch-head</b></a>,
            then just visit <a class="externalLink" href="http://localhost:9200/_plugin/head/" target="_blank">http://localhost:9200/_plugin/head/</a>.
          </li>
        </ol>
      </div>

      
<div class="section">
<h3><a name="Running_the_Demo"></a>Running the Demo</h3>
        
<p>
          To test this scenario, execute the following in the project root folder:
        </p>
        
<div class="brush: bash">
        
<div class="source"><pre class="prettyprint linenums">
$ mvn clean package
$ mvn -Pcargo.run -Dcargo.jvm.args=&quot;-Dsearch.engine=es&quot;
        </pre></div>
        </div>
      </div>

      
<div class="section">
<h3><a name="Testing_the_Demo"></a>Testing the Demo</h3>
        
<p>
          In CMS UI, try to open a published document and take it offline and re-publish the document.
        </p>
        
<p>
          <img src="images/cms-publish.png" alt="Publishsing a document in CMS" />
        </p>
        
<p>
          Now, try to search the content in the Search Engine frontend UI
          (<a class="externalLink" href="http://localhost:9200/_plugin/head/" target="_blank">http://localhost:9200/_plugin/head/</a>).
        </p>
        
<p>
          <img src="images/es-search.png" alt="Querying in Search Engine Frontend" />
        </p>
        
<p>
          Retry to take a document offline or publish an unpublished document and see those synchronized in the
          search engines properly.
        </p>
      </div>

      
<div class="section">
<h3><a name="Camel_Context_Configuration_in_the_demo_project"></a>Camel Context Configuration in the demo project</h3>
        
<p>
          The CamelContext configuration is placed in cms/WEB-INF/camel/routes-with-file.xml like the following example
          which is initiated by <tt>org.springframework.web.context.ContextLoaderListener</tt> defined in
          a &lt;listener&gt; element in cms/WEB-INF/web.xml.
        </p>
        
<div class="brush: xml">
        
<div class="source"><pre class="prettyprint linenums">
  &lt;camelContext xmlns=&quot;http://camel.apache.org/schema/spring&quot;&gt;

    &lt;route id=&quot;Route-HippoEventBus-to-File&quot;&gt;

      &lt;!-- Subscribe publish/depublish events as JSON from HippoEventBus. --&gt;
      &lt;from uri=&quot;hippoevent:?category=workflow&amp;amp;action=publish,depublish&quot; /&gt;

      &lt;!-- Convert the JSON message to String. --&gt;
      &lt;convertBodyTo type=&quot;java.lang.String&quot; /&gt;

      &lt;!-- Store the JSON string to a file in the 'inbox' folder. --&gt;
      &lt;to uri=&quot;file:inbox?autoCreate=true&amp;amp;charset=utf-8&quot; /&gt;

    &lt;/route&gt;

    &lt;route id=&quot;Route-File-to-REST&quot;&gt;

      &lt;!-- Subscribe file events from the 'inbox' folder. --&gt;
      &lt;from uri=&quot;file:inbox?autoCreate=true&amp;amp;charset=utf-8&amp;amp;preMove=.processing&amp;amp;delete=true&amp;amp;moveFailed=.error&quot; /&gt;

      &lt;!-- Convert the file message to String. --&gt;
      &lt;convertBodyTo type=&quot;java.lang.String&quot; /&gt;

      &lt;!-- Convert the JSON string to JSON object. --&gt;
      &lt;convertBodyTo type=&quot;net.sf.json.JSON&quot; /&gt;

      &lt;!-- Set HTTP header to 'POST'. --&gt;
      &lt;setHeader headerName=&quot;CamelHttpMethod&quot;&gt;
        &lt;constant&gt;POST&lt;/constant&gt;
      &lt;/setHeader&gt;

      &lt;!-- Set HTTP query string based on the workflow event message. --&gt;
      &lt;choice&gt;
        &lt;when&gt;
          &lt;simple&gt;${body[action]} == 'publish'&lt;/simple&gt;
          &lt;setHeader headerName=&quot;CamelHttpQuery&quot;&gt;
            &lt;simple&gt;action=index&amp;amp;id=${body[subjectId]}&lt;/simple&gt;
          &lt;/setHeader&gt;
        &lt;/when&gt;
        &lt;when&gt;
          &lt;simple&gt;${body[action]} == 'depublish'&lt;/simple&gt;
          &lt;setHeader headerName=&quot;CamelHttpQuery&quot;&gt;
            &lt;simple&gt;action=delete&amp;amp;id=${body[subjectId]}&lt;/simple&gt;
          &lt;/setHeader&gt;
        &lt;/when&gt;
      &lt;/choice&gt;

      &lt;!-- Invoke the Solr Index synchronization REST service. --&gt;
      &lt;to uri=&quot;http4://localhost:8080/site/restapi/{{search.engine}}/update/&quot; /&gt;

    &lt;/route&gt;

  &lt;/camelContext&gt;
          </pre></div>
        </div>
      </div>

    </div>

  

            </div>
        </div>
    </div>

    <hr/>

    <footer>
                <div class="container-fluid">
                <div class="row span12">Copyright &copy;                                                2017.
                        All Rights Reserved.            
                                        
            </div>

        
        
                </div>
    </footer>
</body>
</html>
